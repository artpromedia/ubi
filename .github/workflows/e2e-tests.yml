# GitHub Actions Workflow - E2E Tests for Rider App
# Runs Flutter integration tests on Android and iOS

name: E2E Tests

on:
  push:
    branches: [main, develop]
    paths:
      - "mobile/apps/rider_app/**"
  pull_request:
    branches: [main, develop]
    paths:
      - "mobile/apps/rider_app/**"
  workflow_dispatch:
    inputs:
      test_filter:
        description: "Filter tests (e.g., onboarding, auth, booking)"
        required: false
        default: ""
      environment:
        description: "Test environment"
        required: false
        default: "staging"
        type: choice
        options:
          - local
          - staging
          - dev

env:
  FLUTTER_VERSION: "3.22.0"
  JAVA_VERSION: "17"
  XCODE_VERSION: "15.4"

concurrency:
  group: e2e-${{ github.ref }}
  cancel-in-progress: true

jobs:
  android-e2e:
    name: Android E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45

    services:
      # Backend services for testing
      test-api:
        image: ubi-test-api:latest
        ports:
          - 3000:3000
        options: >-
          --health-cmd="curl -f http://localhost:3000/health || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}
          cache: "gradle"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            mobile/apps/rider_app/.dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Install dependencies
        working-directory: mobile/apps/rider_app
        run: flutter pub get

      - name: Generate code
        working-directory: mobile/apps/rider_app
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Setup Android emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          target: google_apis
          arch: x86_64
          profile: pixel_6
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          disable-animations: true
          script: |
            cd mobile/apps/rider_app

            # Set test environment
            export TEST_ENV=${{ github.event.inputs.environment || 'staging' }}
            export TEST_FILTER="${{ github.event.inputs.test_filter }}"

            # Run tests with parallel execution
            flutter test integration_test/ \
              --flavor staging \
              --dart-define=ENV=$TEST_ENV \
              --timeout=300 \
              --reporter=json \
              --file-reporter=json:test-results/android-results.json \
              2>&1 | tee test-output.log

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: android-e2e-results
          path: |
            mobile/apps/rider_app/test-results/
            mobile/apps/rider_app/screenshots/
          retention-days: 14

      - name: Upload failure screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: android-failure-screenshots
          path: mobile/apps/rider_app/screenshots/
          retention-days: 30

      - name: Comment on PR
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ Android E2E tests failed. Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details and failure screenshots.'
            })

  ios-e2e:
    name: iOS E2E Tests
    runs-on: macos-14
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -switch /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            mobile/apps/rider_app/.dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: mobile/apps/rider_app/ios/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install dependencies
        working-directory: mobile/apps/rider_app
        run: flutter pub get

      - name: Generate code
        working-directory: mobile/apps/rider_app
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Install CocoaPods
        working-directory: mobile/apps/rider_app/ios
        run: pod install --repo-update

      - name: Boot iOS Simulator
        run: |
          # List available simulators
          xcrun simctl list devices

          # Create and boot iPhone 15 Pro simulator
          DEVICE_ID=$(xcrun simctl create "iPhone 15 Pro Test" "iPhone 15 Pro" "iOS17.5")
          xcrun simctl boot "$DEVICE_ID"
          echo "DEVICE_ID=$DEVICE_ID" >> $GITHUB_ENV

      - name: Run iOS E2E tests
        working-directory: mobile/apps/rider_app
        run: |
          export TEST_ENV=${{ github.event.inputs.environment || 'staging' }}
          export TEST_FILTER="${{ github.event.inputs.test_filter }}"

          flutter test integration_test/ \
            --flavor staging \
            --dart-define=ENV=$TEST_ENV \
            --timeout=300 \
            --reporter=json \
            --file-reporter=json:test-results/ios-results.json \
            2>&1 | tee test-output.log

      - name: Shutdown simulator
        if: always()
        run: xcrun simctl shutdown "${{ env.DEVICE_ID }}" || true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ios-e2e-results
          path: |
            mobile/apps/rider_app/test-results/
            mobile/apps/rider_app/screenshots/
          retention-days: 14

      - name: Upload failure screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: ios-failure-screenshots
          path: mobile/apps/rider_app/screenshots/
          retention-days: 30

  firebase-test-lab:
    name: Firebase Test Lab
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install dependencies
        working-directory: mobile/apps/rider_app
        run: flutter pub get

      - name: Generate code
        working-directory: mobile/apps/rider_app
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Build instrumentation APK
        working-directory: mobile/apps/rider_app
        run: |
          # Build the app APK
          flutter build apk --debug --flavor staging

          # Build the test APK
          pushd android
          ./gradlew app:assembleDebugAndroidTest
          popd

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Run tests on Firebase Test Lab
        run: |
          gcloud firebase test android run \
            --type instrumentation \
            --app mobile/apps/rider_app/build/app/outputs/flutter-apk/app-staging-debug.apk \
            --test mobile/apps/rider_app/build/app/outputs/apk/androidTest/debug/app-debug-androidTest.apk \
            --device model=bluejay,version=34,locale=en,orientation=portrait \
            --device model=oriole,version=33,locale=en,orientation=portrait \
            --timeout 30m \
            --results-bucket=gs://ubi-e2e-test-results \
            --results-dir=${{ github.run_id }}

      - name: Download test results
        if: always()
        run: |
          mkdir -p test-results
          gsutil cp -r gs://ubi-e2e-test-results/${{ github.run_id }}/ test-results/

      - name: Upload Firebase Test Lab results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: firebase-test-lab-results
          path: test-results/
          retention-days: 14

  test-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [android-e2e, ios-e2e]
    if: always()

    steps:
      - name: Download Android results
        uses: actions/download-artifact@v4
        with:
          name: android-e2e-results
          path: android-results/

      - name: Download iOS results
        uses: actions/download-artifact@v4
        with:
          name: ios-e2e-results
          path: ios-results/

      - name: Generate combined report
        run: |
          echo "# E2E Test Results" > report.md
          echo "" >> report.md
          echo "## Summary" >> report.md
          echo "- **Run ID**: ${{ github.run_id }}" >> report.md
          echo "- **Branch**: ${{ github.ref_name }}" >> report.md
          echo "- **Commit**: ${{ github.sha }}" >> report.md
          echo "" >> report.md

          # Parse and combine results
          if [ -f android-results/android-results.json ]; then
            echo "## Android Results" >> report.md
            # Add parsing logic here
          fi

          if [ -f ios-results/ios-results.json ]; then
            echo "## iOS Results" >> report.md
            # Add parsing logic here
          fi

      - name: Upload combined report
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-report
          path: report.md
          retention-days: 14

      - name: Publish test results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: E2E Test Results
          path: "**/*-results.json"
          reporter: flutter-json
          fail-on-error: true
