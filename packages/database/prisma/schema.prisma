// UBI Database Schema
// Prisma schema for PostgreSQL database

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis, pgcrypto, uuid_ossp(map: "uuid-ossp")]
}

// ===========================================
// ENUMS
// ===========================================

enum UserRole {
  RIDER
  DRIVER
  RESTAURANT
  MERCHANT
  FLEET_MANAGER
  ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  PENDING
  ACTIVE
  SUSPENDED
  DEACTIVATED
}

enum RideStatus {
  PENDING
  SEARCHING
  DRIVER_ASSIGNED
  DRIVER_ARRIVING
  DRIVER_ARRIVED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum RideType {
  ECONOMY
  COMFORT
  PREMIUM
  XL
  MOTO
}

enum PaymentMethod {
  CASH
  CARD
  WALLET
  MPESA
  MTN_MOMO
  AIRTEL_MONEY
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  PICKED_UP
  DELIVERING
  DELIVERED
  CANCELLED
}

enum DeliveryStatus {
  PENDING
  PICKED_UP
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  FAILED
  RETURNED
}

enum VehicleType {
  SEDAN
  SUV
  VAN
  MOTORCYCLE
  ELECTRIC
}

enum Currency {
  NGN
  KES
  ZAR
  GHS
  RWF
  ETB
  USD
}

enum AccountType {
  USER_WALLET
  DRIVER_WALLET
  RESTAURANT_WALLET
  UBI_COMMISSION
  UBI_FLOAT
  CEERION_ESCROW
  PROMOTIONAL
  REFUND_RESERVE
}

enum EntryType {
  DEBIT
  CREDIT
}

enum TransactionType {
  WALLET_TOPUP
  WALLET_WITHDRAWAL
  RIDE_PAYMENT
  RIDE_REFUND
  FOOD_PAYMENT
  FOOD_REFUND
  DELIVERY_PAYMENT
  DRIVER_EARNING
  COMMISSION_DEDUCTION
  CEERION_DEDUCTION
  INCENTIVE_BONUS
  PROMOTIONAL_CREDIT
  TIP
  SETTLEMENT_PAYOUT
  INTERNAL_TRANSFER
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REVERSED
  CANCELLED
}

enum PaymentMethodType {
  CARD
  MOBILE_MONEY
  BANK_ACCOUNT
}

enum PaymentProvider {
  PAYSTACK
  FLUTTERWAVE
  MPESA
  MTN_MOMO_GH // Ghana
  MTN_MOMO_RW // Rwanda
  MTN_MOMO_UG // Uganda
  AIRTEL_MONEY
  TELEBIRR
  ORANGE_MONEY
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum RiskAction {
  ALLOW
  REVIEW
  REQUIRE_3DS
  BLOCK
}

// ===========================================
// USER MODELS
// ===========================================

model User {
  id            String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email         String     @unique
  phone         String     @unique
  passwordHash  String     @map("password_hash")
  firstName     String     @map("first_name")
  lastName      String     @map("last_name")
  role          UserRole   @default(RIDER)
  status        UserStatus @default(PENDING)
  avatarUrl     String?    @map("avatar_url")
  emailVerified Boolean    @default(false) @map("email_verified")
  phoneVerified Boolean    @default(false) @map("phone_verified")
  country       String     @db.Char(2)
  language      String     @default("en") @db.VarChar(5)
  currency      Currency   @default(NGN)
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")
  deletedAt     DateTime?  @map("deleted_at")

  // Relations
  driver              Driver?
  rider               Rider?
  restaurant          Restaurant?
  merchant            Merchant?
  walletAccounts      WalletAccount[]
  paymentMethods      PaymentMethodRecord[]
  paymentTransactions PaymentTransaction[]
  notifications       Notification[]
  sessions            Session[]

  @@index([email])
  @@index([phone])
  @@index([role, status])
  @@map("users")
}

model Session {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  token      String   @unique
  deviceType String?  @map("device_type")
  deviceId   String?  @map("device_id")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("sessions")
}

// ===========================================
// RIDER MODELS
// ===========================================

model Rider {
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String        @unique @map("user_id") @db.Uuid
  defaultPayment PaymentMethod @default(CASH) @map("default_payment")
  rating         Float         @default(5.0)
  totalRides     Int           @default(0) @map("total_rides")
  totalSpent     Decimal       @default(0) @map("total_spent") @db.Decimal(12, 2)
  referralCode   String        @unique @map("referral_code")
  referredBy     String?       @map("referred_by") @db.Uuid
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  rides       Ride[]
  savedPlaces SavedPlace[]
  foodOrders  FoodOrder[]
  deliveries  Delivery[]   @relation("DeliverySender")

  @@map("riders")
}

model SavedPlace {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  riderId   String   @map("rider_id") @db.Uuid
  name      String
  address   String
  latitude  Float
  longitude Float
  placeId   String?  @map("place_id")
  type      String   @default("other") // home, work, other
  createdAt DateTime @default(now()) @map("created_at")

  rider Rider @relation(fields: [riderId], references: [id], onDelete: Cascade)

  @@index([riderId])
  @@map("saved_places")
}

// ===========================================
// DRIVER MODELS
// ===========================================

model Driver {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId             String    @unique @map("user_id") @db.Uuid
  licenseNumber      String    @unique @map("license_number")
  licenseExpiry      DateTime  @map("license_expiry")
  vehicleId          String?   @map("vehicle_id") @db.Uuid
  isOnline           Boolean   @default(false) @map("is_online")
  isAvailable        Boolean   @default(false) @map("is_available")
  currentLatitude    Float?    @map("current_latitude")
  currentLongitude   Float?    @map("current_longitude")
  lastLocationUpdate DateTime? @map("last_location_update")
  rating             Float     @default(5.0)
  totalRides         Int       @default(0) @map("total_rides")
  totalEarnings      Decimal   @default(0) @map("total_earnings") @db.Decimal(12, 2)
  acceptanceRate     Float     @default(100) @map("acceptance_rate")
  cancellationRate   Float     @default(0) @map("cancellation_rate")
  verifiedAt         DateTime? @map("verified_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicle  Vehicle?        @relation(fields: [vehicleId], references: [id])
  rides    Ride[]
  earnings DriverEarning[]
  payouts  Payout[]

  @@index([isOnline, isAvailable])
  @@index([currentLatitude, currentLongitude])
  @@map("drivers")
}

model Vehicle {
  id               String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  make             String
  model            String
  year             Int
  color            String
  plateNumber      String      @unique @map("plate_number")
  type             VehicleType
  capacity         Int         @default(4)
  isElectric       Boolean     @default(false) @map("is_electric")
  insuranceExpiry  DateTime?   @map("insurance_expiry")
  inspectionExpiry DateTime?   @map("inspection_expiry")
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")

  drivers        Driver[]
  ceerionVehicle CeerionVehicle?

  @@map("vehicles")
}

model DriverEarning {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  driverId    String   @map("driver_id") @db.Uuid
  rideId      String?  @map("ride_id") @db.Uuid
  orderId     String?  @map("order_id") @db.Uuid
  amount      Decimal  @db.Decimal(12, 2)
  currency    Currency
  type        String // ride, delivery, tip, bonus
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  driver Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([driverId, createdAt])
  @@map("driver_earnings")
}

// ===========================================
// RIDE MODELS
// ===========================================

model Ride {
  id       String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  riderId  String     @map("rider_id") @db.Uuid
  driverId String?    @map("driver_id") @db.Uuid
  status   RideStatus @default(PENDING)
  rideType RideType   @map("ride_type")

  // Pickup location
  pickupAddress   String @map("pickup_address")
  pickupLatitude  Float  @map("pickup_latitude")
  pickupLongitude Float  @map("pickup_longitude")

  // Dropoff location
  dropoffAddress   String @map("dropoff_address")
  dropoffLatitude  Float  @map("dropoff_latitude")
  dropoffLongitude Float  @map("dropoff_longitude")

  // Pricing
  estimatedFare   Decimal  @map("estimated_fare") @db.Decimal(12, 2)
  actualFare      Decimal? @map("actual_fare") @db.Decimal(12, 2)
  currency        Currency
  surgeMultiplier Float    @default(1.0) @map("surge_multiplier")

  // Distance and duration
  estimatedDistance Float  @map("estimated_distance") // in meters
  estimatedDuration Int    @map("estimated_duration") // in seconds
  actualDistance    Float? @map("actual_distance")
  actualDuration    Int?   @map("actual_duration")

  // Timing
  requestedAt DateTime  @default(now()) @map("requested_at")
  acceptedAt  DateTime? @map("accepted_at")
  arrivedAt   DateTime? @map("arrived_at")
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")
  cancelledAt DateTime? @map("cancelled_at")

  // Payment
  paymentMethod PaymentMethod @map("payment_method")
  paymentStatus PaymentStatus @default(PENDING) @map("payment_status")

  // Additional info
  notes              String?
  riderRating        Float?  @map("rider_rating")
  driverRating       Float?  @map("driver_rating")
  cancellationReason String? @map("cancellation_reason")
  cancelledBy        String? @map("cancelled_by")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  rider  Rider   @relation(fields: [riderId], references: [id])
  driver Driver? @relation(fields: [driverId], references: [id])

  @@index([riderId, status])
  @@index([driverId, status])
  @@index([status, createdAt])
  @@map("rides")
}

// ===========================================
// PAYMENT MODELS (COMPREHENSIVE)
// ===========================================

// Double-Entry Ledger: Wallet Accounts
model WalletAccount {
  id               String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId           String?     @map("user_id") @db.Uuid
  accountType      AccountType @map("account_type")
  currency         Currency
  balance          Decimal     @default(0) @db.Decimal(19, 4)
  availableBalance Decimal     @default(0) @map("available_balance") @db.Decimal(19, 4)
  heldBalance      Decimal     @default(0) @map("held_balance") @db.Decimal(19, 4)
  isActive         Boolean     @default(true) @map("is_active")
  metadata         Json?
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")

  user          User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  ledgerEntries LedgerEntry[]
  holds         BalanceHold[]

  @@unique([userId, accountType, currency])
  @@index([userId])
  @@index([accountType])
  @@index([currency])
  @@map("wallet_accounts")
}

// Immutable Ledger Entries (Double-Entry Bookkeeping)
model LedgerEntry {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  transactionId String    @map("transaction_id") @db.Uuid
  accountId     String    @map("account_id") @db.Uuid
  entryType     EntryType @map("entry_type")
  amount        Decimal   @db.Decimal(19, 4)
  balanceAfter  Decimal   @map("balance_after") @db.Decimal(19, 4)
  description   String?
  metadata      Json?
  createdAt     DateTime  @default(now()) @map("created_at")

  transaction Transaction   @relation(fields: [transactionId], references: [id])
  account     WalletAccount @relation(fields: [accountId], references: [id])

  @@index([transactionId])
  @@index([accountId, createdAt])
  @@index([createdAt])
  @@map("ledger_entries")
}

// Transactions (Group Ledger Entries)
model Transaction {
  id              String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  idempotencyKey  String            @unique @map("idempotency_key")
  transactionType TransactionType   @map("transaction_type")
  status          TransactionStatus @default(PENDING)
  amount          Decimal           @db.Decimal(19, 4)
  currency        Currency
  fee             Decimal           @default(0) @db.Decimal(19, 4)
  description     String?
  metadata        Json?
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  completedAt     DateTime?         @map("completed_at")

  ledgerEntries      LedgerEntry[]
  paymentTransaction PaymentTransaction?
  payout             Payout?

  @@index([status, createdAt])
  @@index([transactionType])
  @@index([idempotencyKey])
  @@index([createdAt])
  @@map("transactions")
}

// Payment Methods (Tokenized)
model PaymentMethodRecord {
  id            String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String            @map("user_id") @db.Uuid
  type          PaymentMethodType
  provider      PaymentProvider
  token         String // Provider authorization token/code
  lastFour      String?           @map("last_four") // Last 4 digits of card/account
  brand         String? // visa, mastercard, verve, mpesa, mtn
  phoneNumber   String?           @map("phone_number")
  bankCode      String?           @map("bank_code")
  accountNumber String?           @map("account_number") // Masked
  accountName   String?           @map("account_name")
  isDefault     Boolean           @default(false) @map("is_default")
  isVerified    Boolean           @default(false) @map("is_verified")
  expiresAt     DateTime?         @map("expires_at") // For cards
  metadata      Json? // Additional provider data
  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")

  user     User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments PaymentTransaction[]

  @@index([userId])
  @@index([userId, isDefault])
  @@index([type, provider])
  @@map("payment_methods")
}

// Payment Transactions (External Payments)
model PaymentTransaction {
  id                String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String          @map("user_id") @db.Uuid
  paymentMethodId   String?         @map("payment_method_id") @db.Uuid
  transactionId     String?         @unique @map("transaction_id") @db.Uuid // Link to Transaction
  provider          PaymentProvider
  providerReference String?         @unique @map("provider_reference") // Provider's transaction ID
  amount            Decimal         @db.Decimal(19, 4)
  currency          Currency
  status            PaymentStatus   @default(PENDING)
  initiatedAt       DateTime        @default(now()) @map("initiated_at")
  confirmedAt       DateTime?       @map("confirmed_at")
  failedAt          DateTime?       @map("failed_at")
  failureReason     String?         @map("failure_reason")
  providerResponse  Json?           @map("provider_response")
  webhookReceived   Boolean         @default(false) @map("webhook_received")
  metadata          Json?
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  user          User                 @relation(fields: [userId], references: [id])
  paymentMethod PaymentMethodRecord? @relation(fields: [paymentMethodId], references: [id])
  transaction   Transaction?         @relation(fields: [transactionId], references: [id])
  riskScore     RiskAssessment?
  refunds       Refund[]

  @@index([userId, status])
  @@index([status, createdAt])
  @@index([provider, providerReference])
  @@index([createdAt])
  @@map("payment_transactions")
}

// Balance Holds (Pre-authorization)
model BalanceHold {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  accountId  String    @map("account_id") @db.Uuid
  amount     Decimal   @db.Decimal(19, 4)
  currency   Currency
  reason     String
  reference  String?
  isReleased Boolean   @default(false) @map("is_released")
  releasedAt DateTime? @map("released_at")
  expiresAt  DateTime  @map("expires_at")
  metadata   Json?
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  account WalletAccount @relation(fields: [accountId], references: [id])

  @@index([accountId, isReleased])
  @@index([expiresAt])
  @@map("balance_holds")
}

// Driver Payouts
model Payout {
  id                String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  driverId          String          @map("driver_id") @db.Uuid
  transactionId     String?         @unique @map("transaction_id") @db.Uuid
  amount            Decimal         @db.Decimal(19, 4)
  fee               Decimal         @default(0) @db.Decimal(19, 4)
  netAmount         Decimal         @map("net_amount") @db.Decimal(19, 4)
  currency          Currency
  status            PayoutStatus    @default(PENDING)
  provider          PaymentProvider
  providerReference String?         @map("provider_reference")
  payoutMethod      String          @map("payout_method") // mobile_money, bank_transfer
  accountNumber     String          @map("account_number")
  accountName       String?         @map("account_name")
  initiatedAt       DateTime        @default(now()) @map("initiated_at")
  completedAt       DateTime?       @map("completed_at")
  failedAt          DateTime?       @map("failed_at")
  failureReason     String?         @map("failure_reason")
  metadata          Json?
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  driver      Driver       @relation(fields: [driverId], references: [id])
  transaction Transaction? @relation(fields: [transactionId], references: [id])

  @@index([driverId, status])
  @@index([status, createdAt])
  @@index([provider, providerReference])
  @@map("payouts")
}

// Fraud Detection: Risk Assessments
model RiskAssessment {
  id                   String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  paymentTransactionId String       @unique @map("payment_transaction_id") @db.Uuid
  userId               String       @map("user_id") @db.Uuid
  score                Int // 0-100
  level                RiskLevel
  action               RiskAction
  factors              RiskFactor[]
  deviceFingerprint    String?      @map("device_fingerprint")
  ipAddress            String?      @map("ip_address")
  ipLocation           Json?        @map("ip_location")
  reviewedAt           DateTime?    @map("reviewed_at")
  reviewedBy           String?      @map("reviewed_by") @db.Uuid
  reviewNotes          String?      @map("review_notes")
  createdAt            DateTime     @default(now()) @map("created_at")

  paymentTransaction PaymentTransaction @relation(fields: [paymentTransactionId], references: [id])

  @@index([userId, level])
  @@index([level, action])
  @@index([createdAt])
  @@map("risk_assessments")
}

// Risk Factors (Embedded in RiskAssessment)
model RiskFactor {
  id               String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  riskAssessmentId String  @map("risk_assessment_id") @db.Uuid
  name             String
  score            Int
  details          String?
  metadata         Json?

  riskAssessment RiskAssessment @relation(fields: [riskAssessmentId], references: [id], onDelete: Cascade)

  @@index([riskAssessmentId])
  @@map("risk_factors")
}

// Reconciliation Records
model ReconciliationReport {
  id                String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  date              DateTime
  provider          PaymentProvider
  currency          Currency
  totalInternal     Int             @map("total_internal")
  totalProvider     Int             @map("total_provider")
  matched           Int
  unmatchedInternal Int             @map("unmatched_internal")
  unmatchedProvider Int             @map("unmatched_provider")
  discrepancies     Int
  internalAmount    Decimal         @map("internal_amount") @db.Decimal(19, 4)
  providerAmount    Decimal         @map("provider_amount") @db.Decimal(19, 4)
  amountDifference  Decimal         @map("amount_difference") @db.Decimal(19, 4)
  status            String          @default("pending") // pending, reviewed, resolved
  reviewedAt        DateTime?       @map("reviewed_at")
  reviewedBy        String?         @map("reviewed_by") @db.Uuid
  notes             String?
  reportData        Json?           @map("report_data")
  createdAt         DateTime        @default(now()) @map("created_at")

  discrepancyRecords ReconciliationDiscrepancy[]

  @@unique([date, provider, currency])
  @@index([date, provider])
  @@index([status])
  @@map("reconciliation_reports")
}

// Reconciliation Discrepancies
model ReconciliationDiscrepancy {
  id                     String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  reconciliationReportId String    @map("reconciliation_report_id") @db.Uuid
  type                   String // MISSING_IN_UBI, MISSING_IN_PROVIDER, AMOUNT_MISMATCH, STATUS_MISMATCH
  severity               String // LOW, MEDIUM, HIGH, CRITICAL
  transactionId          String?   @map("transaction_id") @db.Uuid
  providerReference      String?   @map("provider_reference")
  ubiAmount              Decimal?  @map("ubi_amount") @db.Decimal(19, 4)
  providerAmount         Decimal?  @map("provider_amount") @db.Decimal(19, 4)
  difference             Decimal?  @db.Decimal(19, 4)
  currency               Currency
  description            String
  status                 String    @default("pending") // pending, investigating, resolved, ignored
  resolution             String?
  resolvedAt             DateTime? @map("resolved_at")
  resolvedBy             String?   @map("resolved_by") @db.Uuid
  notes                  String?
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  reconciliationReport ReconciliationReport @relation(fields: [reconciliationReportId], references: [id])

  @@index([reconciliationReportId, status])
  @@index([type, severity])
  @@index([status, createdAt])
  @@map("reconciliation_discrepancies")
}

// Balance Reconciliation (Daily snapshots)
model BalanceReconciliation {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  date            DateTime
  provider        PaymentProvider
  currency        Currency
  ubiBalance      Decimal         @map("ubi_balance") @db.Decimal(19, 4)
  providerBalance Decimal         @map("provider_balance") @db.Decimal(19, 4)
  difference      Decimal         @db.Decimal(19, 4)
  percentageDiff  Float           @map("percentage_diff")
  status          String          @default("pending") // pending, matched, discrepancy, resolved
  notes           String?
  createdAt       DateTime        @default(now()) @map("created_at")

  @@unique([date, provider, currency])
  @@index([provider, date])
  @@map("balance_reconciliations")
}

// Settlement Records
model Settlement {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  recipientId      String   @map("recipient_id") @db.Uuid
  recipientType    String   @map("recipient_type") // RESTAURANT, MERCHANT, DRIVER, PARTNER
  periodStart      DateTime @map("period_start")
  periodEnd        DateTime @map("period_end")
  grossAmount      Decimal  @map("gross_amount") @db.Decimal(19, 4)
  ubiCommission    Decimal  @map("ubi_commission") @db.Decimal(19, 4)
  ceerionDeduction Decimal  @map("ceerion_deduction") @db.Decimal(19, 4)
  settlementFee    Decimal  @map("settlement_fee") @db.Decimal(19, 4)
  netAmount        Decimal  @map("net_amount") @db.Decimal(19, 4)
  currency         Currency

  status            String    @default("pending") // pending, processing, completed, failed
  payoutMethod      String    @map("payout_method") // bank_transfer, mobile_money
  payoutDestination Json      @map("payout_destination") // Bank or mobile money details
  providerReference String?   @map("provider_reference")
  processedAt       DateTime? @map("processed_at")
  failureReason     String?   @map("failure_reason")
  retryCount        Int       @default(0) @map("retry_count")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([recipientId, recipientType])
  @@index([status, createdAt])
  @@index([periodStart, periodEnd])
  @@map("settlements")
}

// Refund Records
model Refund {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  transactionId String    @map("transaction_id") @db.Uuid
  amount        Decimal   @db.Decimal(19, 4)
  currency      Currency
  reason        String
  status        String    @default("pending") // pending, processing, completed, failed
  initiatedBy   String    @map("initiated_by") @db.Uuid
  processedAt   DateTime? @map("processed_at")
  failureReason String?   @map("failure_reason")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  transaction PaymentTransaction @relation(fields: [transactionId], references: [id])

  @@index([transactionId])
  @@index([status, createdAt])
  @@map("refunds")
}

// Alerts for Operations Team
model Alert {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type           String // CRITICAL_DISCREPANCY, FRAUD_DETECTED, SETTLEMENT_FAILED, PROVIDER_DOWN
  severity       String // LOW, MEDIUM, HIGH, CRITICAL
  title          String
  message        String
  data           Json?
  acknowledged   Boolean   @default(false)
  acknowledgedAt DateTime? @map("acknowledged_at")
  acknowledgedBy String?   @map("acknowledged_by") @db.Uuid
  resolved       Boolean   @default(false)
  resolvedAt     DateTime? @map("resolved_at")
  resolvedBy     String?   @map("resolved_by") @db.Uuid
  createdAt      DateTime  @default(now()) @map("created_at")

  @@index([type, severity])
  @@index([acknowledged, resolved])
  @@index([createdAt])
  @@map("alerts")
}

// Webhook Events (Idempotency)
model WebhookEvent {
  id          String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  provider    PaymentProvider
  eventId     String          @map("event_id") // Provider's event ID
  eventType   String          @map("event_type")
  payload     Json
  processed   Boolean         @default(false)
  processedAt DateTime?       @map("processed_at")
  retryCount  Int             @default(0) @map("retry_count")
  lastRetryAt DateTime?       @map("last_retry_at")
  error       String?
  createdAt   DateTime        @default(now()) @map("created_at")

  @@unique([provider, eventId])
  @@index([processed, createdAt])
  @@index([provider, eventType])
  @@map("webhook_events")
}

// Chargebacks and Disputes
model Dispute {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  paymentTransactionId String    @map("payment_transaction_id") @db.Uuid
  userId               String    @map("user_id") @db.Uuid
  type                 String // chargeback, refund_request, payment_dispute
  status               String    @default("open") // open, under_review, won, lost, closed
  amount               Decimal   @db.Decimal(19, 4)
  currency             Currency
  reason               String
  evidence             Json? // Files, screenshots, GPS data
  providerReference    String?   @map("provider_reference")
  openedAt             DateTime  @default(now()) @map("opened_at")
  respondedAt          DateTime? @map("responded_at")
  resolvedAt           DateTime? @map("resolved_at")
  resolution           String? // won, lost, withdrawn
  notes                String?
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  @@index([userId, status])
  @@index([status, openedAt])
  @@index([providerReference])
  @@map("disputes")
}

// Provider Health Monitoring
model ProviderHealth {
  id                  String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  provider            PaymentProvider
  isHealthy           Boolean         @default(true) @map("is_healthy")
  lastCheckAt         DateTime        @default(now()) @map("last_check_at")
  consecutiveFailures Int             @default(0) @map("consecutive_failures")
  avgResponseTime     Int?            @map("avg_response_time") // milliseconds
  successRate         Float?          @map("success_rate") // percentage
  lastIncidentAt      DateTime?       @map("last_incident_at")
  metadata            Json?
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")

  @@unique([provider])
  @@map("provider_health")
}

// ===========================================
// RESTAURANT & FOOD ORDER MODELS
// ===========================================

model Restaurant {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                String    @unique @map("user_id") @db.Uuid
  name                  String
  description           String?
  address               String
  latitude              Float
  longitude             Float
  phone                 String
  email                 String
  imageUrl              String?   @map("image_url")
  coverUrl              String?   @map("cover_url")
  cuisineTypes          String[]  @map("cuisine_types")
  rating                Float     @default(5.0)
  totalOrders           Int       @default(0) @map("total_orders")
  isOpen                Boolean   @default(false) @map("is_open")
  openingHours          Json?     @map("opening_hours")
  minimumOrder          Decimal   @default(0) @map("minimum_order") @db.Decimal(12, 2)
  deliveryFee           Decimal   @default(0) @map("delivery_fee") @db.Decimal(12, 2)
  estimatedDeliveryTime Int       @default(30) @map("estimated_delivery_time") // minutes
  verifiedAt            DateTime? @map("verified_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  menuItems MenuItem[]
  orders    FoodOrder[]

  @@index([latitude, longitude])
  @@index([isOpen, rating])
  @@map("restaurants")
}

model MenuItem {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  restaurantId String   @map("restaurant_id") @db.Uuid
  name         String
  description  String?
  price        Decimal  @db.Decimal(12, 2)
  imageUrl     String?  @map("image_url")
  category     String
  isAvailable  Boolean  @default(true) @map("is_available")
  options      Json? // customization options
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  restaurant Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]

  @@index([restaurantId, category])
  @@map("menu_items")
}

model FoodOrder {
  id                String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  riderId           String        @map("rider_id") @db.Uuid
  restaurantId      String        @map("restaurant_id") @db.Uuid
  status            OrderStatus   @default(PENDING)
  subtotal          Decimal       @db.Decimal(12, 2)
  deliveryFee       Decimal       @map("delivery_fee") @db.Decimal(12, 2)
  serviceFee        Decimal       @default(0) @map("service_fee") @db.Decimal(12, 2)
  tip               Decimal       @default(0) @db.Decimal(12, 2)
  total             Decimal       @db.Decimal(12, 2)
  currency          Currency
  deliveryAddress   String        @map("delivery_address")
  deliveryLatitude  Float         @map("delivery_latitude")
  deliveryLongitude Float         @map("delivery_longitude")
  notes             String?
  paymentMethod     PaymentMethod @map("payment_method")
  paymentStatus     PaymentStatus @default(PENDING) @map("payment_status")
  estimatedDelivery DateTime?     @map("estimated_delivery")
  deliveredAt       DateTime?     @map("delivered_at")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  rider      Rider       @relation(fields: [riderId], references: [id])
  restaurant Restaurant  @relation(fields: [restaurantId], references: [id])
  items      OrderItem[]

  @@index([riderId, status])
  @@index([restaurantId, status])
  @@map("food_orders")
}

model OrderItem {
  id         String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId    String  @map("order_id") @db.Uuid
  menuItemId String  @map("menu_item_id") @db.Uuid
  quantity   Int
  unitPrice  Decimal @map("unit_price") @db.Decimal(12, 2)
  totalPrice Decimal @map("total_price") @db.Decimal(12, 2)
  options    Json? // selected options
  notes      String?

  order    FoodOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem MenuItem  @relation(fields: [menuItemId], references: [id])

  @@map("order_items")
}

// ===========================================
// DELIVERY MODELS
// ===========================================

model Merchant {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String    @unique @map("user_id") @db.Uuid
  businessName   String    @map("business_name")
  address        String
  latitude       Float
  longitude      Float
  totalShipments Int       @default(0) @map("total_shipments")
  verifiedAt     DateTime? @map("verified_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  deliveries Delivery[]

  @@map("merchants")
}

model Delivery {
  id         String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  senderId   String         @map("sender_id") @db.Uuid
  merchantId String?        @map("merchant_id") @db.Uuid
  status     DeliveryStatus @default(PENDING)

  // Pickup
  pickupAddress   String @map("pickup_address")
  pickupLatitude  Float  @map("pickup_latitude")
  pickupLongitude Float  @map("pickup_longitude")
  pickupContact   String @map("pickup_contact")
  pickupPhone     String @map("pickup_phone")

  // Dropoff
  dropoffAddress   String @map("dropoff_address")
  dropoffLatitude  Float  @map("dropoff_latitude")
  dropoffLongitude Float  @map("dropoff_longitude")
  dropoffContact   String @map("dropoff_contact")
  dropoffPhone     String @map("dropoff_phone")

  // Package details
  packageSize        String  @map("package_size") // small, medium, large, xl
  packageWeight      Float?  @map("package_weight") // kg
  packageDescription String  @map("package_description")
  isFragile          Boolean @default(false) @map("is_fragile")
  requiresSignature  Boolean @default(false) @map("requires_signature")

  // Pricing
  price    Decimal  @db.Decimal(12, 2)
  currency Currency

  // Timing
  estimatedPickup   DateTime? @map("estimated_pickup")
  estimatedDelivery DateTime? @map("estimated_delivery")
  pickedUpAt        DateTime? @map("picked_up_at")
  deliveredAt       DateTime? @map("delivered_at")

  // Payment
  paymentMethod PaymentMethod @map("payment_method")
  paymentStatus PaymentStatus @default(PENDING) @map("payment_status")

  // Tracking
  trackingNumber  String  @unique @map("tracking_number")
  proofOfDelivery String? @map("proof_of_delivery") // URL to photo
  signature       String? // URL to signature image

  notes     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  sender   Rider     @relation("DeliverySender", fields: [senderId], references: [id])
  merchant Merchant? @relation(fields: [merchantId], references: [id])

  @@index([senderId, status])
  @@index([trackingNumber])
  @@map("deliveries")
}

// ===========================================
// CEERION (EV FINANCING) MODELS
// ===========================================

model CeerionVehicle {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  vehicleId       String   @unique @map("vehicle_id") @db.Uuid
  financingStatus String   @default("active") @map("financing_status") // active, paid_off, defaulted
  totalAmount     Decimal  @map("total_amount") @db.Decimal(12, 2)
  amountPaid      Decimal  @default(0) @map("amount_paid") @db.Decimal(12, 2)
  amountRemaining Decimal  @map("amount_remaining") @db.Decimal(12, 2)
  currency        Currency
  weeklyPayment   Decimal  @map("weekly_payment") @db.Decimal(12, 2)
  paymentDay      Int      @map("payment_day") // day of week
  startDate       DateTime @map("start_date")
  endDate         DateTime @map("end_date")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  vehicle  Vehicle          @relation(fields: [vehicleId], references: [id])
  payments CeerionPayment[]

  @@map("ceerion_vehicles")
}

model CeerionPayment {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ceerionVehicleId String    @map("ceerion_vehicle_id") @db.Uuid
  amount           Decimal   @db.Decimal(12, 2)
  dueDate          DateTime  @map("due_date")
  paidAt           DateTime? @map("paid_at")
  status           String    @default("pending") // pending, paid, overdue
  source           String? // manual, auto_deduction
  createdAt        DateTime  @default(now()) @map("created_at")

  ceerionVehicle CeerionVehicle @relation(fields: [ceerionVehicleId], references: [id])

  @@index([ceerionVehicleId, status])
  @@map("ceerion_payments")
}

// ===========================================
// NOTIFICATION MODELS
// ===========================================

model Notification {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  type      String // ride_update, payment, promo, system
  title     String
  body      String
  data      Json?
  read      Boolean   @default(false)
  readAt    DateTime? @map("read_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read, createdAt])
  @@map("notifications")
}
