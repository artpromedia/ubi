// UBI Database Schema
// Prisma schema for PostgreSQL database

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres", "postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [postgis, pgcrypto, uuid_ossp(map: "uuid-ossp")]
}

// ===========================================
// ENUMS
// ===========================================

enum UserRole {
  RIDER
  DRIVER
  RESTAURANT
  MERCHANT
  FLEET_MANAGER
  ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  PENDING
  ACTIVE
  SUSPENDED
  DEACTIVATED
}

enum RideStatus {
  PENDING
  SEARCHING
  DRIVER_ASSIGNED
  DRIVER_ARRIVING
  DRIVER_ARRIVED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum RideType {
  ECONOMY
  COMFORT
  PREMIUM
  XL
  MOTO
}

enum PaymentMethod {
  CASH
  CARD
  WALLET
  MPESA
  MTN_MOMO
  AIRTEL_MONEY
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  PICKED_UP
  DELIVERING
  DELIVERED
  CANCELLED
}

enum DeliveryStatus {
  PENDING
  PICKED_UP
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  FAILED
  RETURNED
}

enum VehicleType {
  SEDAN
  SUV
  VAN
  MOTORCYCLE
  ELECTRIC
}

enum Currency {
  NGN
  KES
  ZAR
  GHS
  RWF
  ETB
  USD
}

// ===========================================
// USER MODELS
// ===========================================

model User {
  id            String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email         String     @unique
  phone         String     @unique
  passwordHash  String     @map("password_hash")
  firstName     String     @map("first_name")
  lastName      String     @map("last_name")
  role          UserRole   @default(RIDER)
  status        UserStatus @default(PENDING)
  avatarUrl     String?    @map("avatar_url")
  emailVerified Boolean    @default(false) @map("email_verified")
  phoneVerified Boolean    @default(false) @map("phone_verified")
  country       String     @db.Char(2)
  language      String     @default("en") @db.VarChar(5)
  currency      Currency   @default(NGN)
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")
  deletedAt     DateTime?  @map("deleted_at")

  // Relations
  driver        Driver?
  rider         Rider?
  restaurant    Restaurant?
  merchant      Merchant?
  wallet        Wallet?
  notifications Notification[]
  sessions      Session[]

  @@index([email])
  @@index([phone])
  @@index([role, status])
  @@map("users")
}

model Session {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  token      String   @unique
  deviceType String?  @map("device_type")
  deviceId   String?  @map("device_id")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("sessions")
}

// ===========================================
// RIDER MODELS
// ===========================================

model Rider {
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String        @unique @map("user_id") @db.Uuid
  defaultPayment PaymentMethod @default(CASH) @map("default_payment")
  rating         Float         @default(5.0)
  totalRides     Int           @default(0) @map("total_rides")
  totalSpent     Decimal       @default(0) @map("total_spent") @db.Decimal(12, 2)
  referralCode   String        @unique @map("referral_code")
  referredBy     String?       @map("referred_by") @db.Uuid
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  rides       Ride[]
  savedPlaces SavedPlace[]
  foodOrders  FoodOrder[]
  deliveries  Delivery[]   @relation("DeliverySender")

  @@map("riders")
}

model SavedPlace {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  riderId   String   @map("rider_id") @db.Uuid
  name      String
  address   String
  latitude  Float
  longitude Float
  placeId   String?  @map("place_id")
  type      String   @default("other") // home, work, other
  createdAt DateTime @default(now()) @map("created_at")

  rider Rider @relation(fields: [riderId], references: [id], onDelete: Cascade)

  @@index([riderId])
  @@map("saved_places")
}

// ===========================================
// DRIVER MODELS
// ===========================================

model Driver {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId             String    @unique @map("user_id") @db.Uuid
  licenseNumber      String    @unique @map("license_number")
  licenseExpiry      DateTime  @map("license_expiry")
  vehicleId          String?   @map("vehicle_id") @db.Uuid
  isOnline           Boolean   @default(false) @map("is_online")
  isAvailable        Boolean   @default(false) @map("is_available")
  currentLatitude    Float?    @map("current_latitude")
  currentLongitude   Float?    @map("current_longitude")
  lastLocationUpdate DateTime? @map("last_location_update")
  rating             Float     @default(5.0)
  totalRides         Int       @default(0) @map("total_rides")
  totalEarnings      Decimal   @default(0) @map("total_earnings") @db.Decimal(12, 2)
  acceptanceRate     Float     @default(100) @map("acceptance_rate")
  cancellationRate   Float     @default(0) @map("cancellation_rate")
  verifiedAt         DateTime? @map("verified_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicle  Vehicle?        @relation(fields: [vehicleId], references: [id])
  rides    Ride[]
  earnings DriverEarning[]

  @@index([isOnline, isAvailable])
  @@index([currentLatitude, currentLongitude])
  @@map("drivers")
}

model Vehicle {
  id               String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  make             String
  model            String
  year             Int
  color            String
  plateNumber      String      @unique @map("plate_number")
  type             VehicleType
  capacity         Int         @default(4)
  isElectric       Boolean     @default(false) @map("is_electric")
  insuranceExpiry  DateTime?   @map("insurance_expiry")
  inspectionExpiry DateTime?   @map("inspection_expiry")
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")

  drivers        Driver[]
  ceerionVehicle CeerionVehicle?

  @@map("vehicles")
}

model DriverEarning {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  driverId    String   @map("driver_id") @db.Uuid
  rideId      String?  @map("ride_id") @db.Uuid
  orderId     String?  @map("order_id") @db.Uuid
  amount      Decimal  @db.Decimal(12, 2)
  currency    Currency
  type        String // ride, delivery, tip, bonus
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  driver Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([driverId, createdAt])
  @@map("driver_earnings")
}

// ===========================================
// RIDE MODELS
// ===========================================

model Ride {
  id       String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  riderId  String     @map("rider_id") @db.Uuid
  driverId String?    @map("driver_id") @db.Uuid
  status   RideStatus @default(PENDING)
  rideType RideType   @map("ride_type")

  // Pickup location
  pickupAddress   String @map("pickup_address")
  pickupLatitude  Float  @map("pickup_latitude")
  pickupLongitude Float  @map("pickup_longitude")

  // Dropoff location
  dropoffAddress   String @map("dropoff_address")
  dropoffLatitude  Float  @map("dropoff_latitude")
  dropoffLongitude Float  @map("dropoff_longitude")

  // Pricing
  estimatedFare   Decimal  @map("estimated_fare") @db.Decimal(12, 2)
  actualFare      Decimal? @map("actual_fare") @db.Decimal(12, 2)
  currency        Currency
  surgeMultiplier Float    @default(1.0) @map("surge_multiplier")

  // Distance and duration
  estimatedDistance Float  @map("estimated_distance") // in meters
  estimatedDuration Int    @map("estimated_duration") // in seconds
  actualDistance    Float? @map("actual_distance")
  actualDuration    Int?   @map("actual_duration")

  // Timing
  requestedAt DateTime  @default(now()) @map("requested_at")
  acceptedAt  DateTime? @map("accepted_at")
  arrivedAt   DateTime? @map("arrived_at")
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")
  cancelledAt DateTime? @map("cancelled_at")

  // Payment
  paymentMethod PaymentMethod @map("payment_method")
  paymentStatus PaymentStatus @default(PENDING) @map("payment_status")

  // Additional info
  notes              String?
  riderRating        Float?  @map("rider_rating")
  driverRating       Float?  @map("driver_rating")
  cancellationReason String? @map("cancellation_reason")
  cancelledBy        String? @map("cancelled_by")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  rider   Rider    @relation(fields: [riderId], references: [id])
  driver  Driver?  @relation(fields: [driverId], references: [id])
  payment Payment?

  @@index([riderId, status])
  @@index([driverId, status])
  @@index([status, createdAt])
  @@map("rides")
}

// ===========================================
// PAYMENT MODELS
// ===========================================

model Wallet {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @unique @map("user_id") @db.Uuid
  balance   Decimal  @default(0) @db.Decimal(12, 2)
  currency  Currency
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions WalletTransaction[]

  @@map("wallets")
}

model WalletTransaction {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  walletId    String   @map("wallet_id") @db.Uuid
  amount      Decimal  @db.Decimal(12, 2)
  type        String // credit, debit
  description String
  reference   String?
  createdAt   DateTime @default(now()) @map("created_at")

  wallet Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId, createdAt])
  @@map("wallet_transactions")
}

model Payment {
  id               String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  rideId           String?       @unique @map("ride_id") @db.Uuid
  foodOrderId      String?       @unique @map("food_order_id") @db.Uuid
  deliveryId       String?       @unique @map("delivery_id") @db.Uuid
  amount           Decimal       @db.Decimal(12, 2)
  currency         Currency
  method           PaymentMethod
  status           PaymentStatus @default(PENDING)
  providerRef      String?       @map("provider_ref")
  providerResponse Json?         @map("provider_response")
  failureReason    String?       @map("failure_reason")
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  ride      Ride?      @relation(fields: [rideId], references: [id])
  foodOrder FoodOrder? @relation(fields: [foodOrderId], references: [id])
  delivery  Delivery?  @relation(fields: [deliveryId], references: [id])

  @@index([status, createdAt])
  @@map("payments")
}

// ===========================================
// RESTAURANT & FOOD ORDER MODELS
// ===========================================

model Restaurant {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                String    @unique @map("user_id") @db.Uuid
  name                  String
  description           String?
  address               String
  latitude              Float
  longitude             Float
  phone                 String
  email                 String
  imageUrl              String?   @map("image_url")
  coverUrl              String?   @map("cover_url")
  cuisineTypes          String[]  @map("cuisine_types")
  rating                Float     @default(5.0)
  totalOrders           Int       @default(0) @map("total_orders")
  isOpen                Boolean   @default(false) @map("is_open")
  openingHours          Json?     @map("opening_hours")
  minimumOrder          Decimal   @default(0) @map("minimum_order") @db.Decimal(12, 2)
  deliveryFee           Decimal   @default(0) @map("delivery_fee") @db.Decimal(12, 2)
  estimatedDeliveryTime Int       @default(30) @map("estimated_delivery_time") // minutes
  verifiedAt            DateTime? @map("verified_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  menuItems MenuItem[]
  orders    FoodOrder[]

  @@index([latitude, longitude])
  @@index([isOpen, rating])
  @@map("restaurants")
}

model MenuItem {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  restaurantId String   @map("restaurant_id") @db.Uuid
  name         String
  description  String?
  price        Decimal  @db.Decimal(12, 2)
  imageUrl     String?  @map("image_url")
  category     String
  isAvailable  Boolean  @default(true) @map("is_available")
  options      Json? // customization options
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  restaurant Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]

  @@index([restaurantId, category])
  @@map("menu_items")
}

model FoodOrder {
  id                String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  riderId           String        @map("rider_id") @db.Uuid
  restaurantId      String        @map("restaurant_id") @db.Uuid
  status            OrderStatus   @default(PENDING)
  subtotal          Decimal       @db.Decimal(12, 2)
  deliveryFee       Decimal       @map("delivery_fee") @db.Decimal(12, 2)
  serviceFee        Decimal       @default(0) @map("service_fee") @db.Decimal(12, 2)
  tip               Decimal       @default(0) @db.Decimal(12, 2)
  total             Decimal       @db.Decimal(12, 2)
  currency          Currency
  deliveryAddress   String        @map("delivery_address")
  deliveryLatitude  Float         @map("delivery_latitude")
  deliveryLongitude Float         @map("delivery_longitude")
  notes             String?
  paymentMethod     PaymentMethod @map("payment_method")
  paymentStatus     PaymentStatus @default(PENDING) @map("payment_status")
  estimatedDelivery DateTime?     @map("estimated_delivery")
  deliveredAt       DateTime?     @map("delivered_at")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  rider      Rider       @relation(fields: [riderId], references: [id])
  restaurant Restaurant  @relation(fields: [restaurantId], references: [id])
  items      OrderItem[]
  payment    Payment?

  @@index([riderId, status])
  @@index([restaurantId, status])
  @@map("food_orders")
}

model OrderItem {
  id         String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId    String  @map("order_id") @db.Uuid
  menuItemId String  @map("menu_item_id") @db.Uuid
  quantity   Int
  unitPrice  Decimal @map("unit_price") @db.Decimal(12, 2)
  totalPrice Decimal @map("total_price") @db.Decimal(12, 2)
  options    Json? // selected options
  notes      String?

  order    FoodOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem MenuItem  @relation(fields: [menuItemId], references: [id])

  @@map("order_items")
}

// ===========================================
// DELIVERY MODELS
// ===========================================

model Merchant {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String    @unique @map("user_id") @db.Uuid
  businessName   String    @map("business_name")
  address        String
  latitude       Float
  longitude      Float
  totalShipments Int       @default(0) @map("total_shipments")
  verifiedAt     DateTime? @map("verified_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  deliveries Delivery[]

  @@map("merchants")
}

model Delivery {
  id         String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  senderId   String         @map("sender_id") @db.Uuid
  merchantId String?        @map("merchant_id") @db.Uuid
  status     DeliveryStatus @default(PENDING)

  // Pickup
  pickupAddress   String @map("pickup_address")
  pickupLatitude  Float  @map("pickup_latitude")
  pickupLongitude Float  @map("pickup_longitude")
  pickupContact   String @map("pickup_contact")
  pickupPhone     String @map("pickup_phone")

  // Dropoff
  dropoffAddress   String @map("dropoff_address")
  dropoffLatitude  Float  @map("dropoff_latitude")
  dropoffLongitude Float  @map("dropoff_longitude")
  dropoffContact   String @map("dropoff_contact")
  dropoffPhone     String @map("dropoff_phone")

  // Package details
  packageSize        String  @map("package_size") // small, medium, large, xl
  packageWeight      Float?  @map("package_weight") // kg
  packageDescription String  @map("package_description")
  isFragile          Boolean @default(false) @map("is_fragile")
  requiresSignature  Boolean @default(false) @map("requires_signature")

  // Pricing
  price    Decimal  @db.Decimal(12, 2)
  currency Currency

  // Timing
  estimatedPickup   DateTime? @map("estimated_pickup")
  estimatedDelivery DateTime? @map("estimated_delivery")
  pickedUpAt        DateTime? @map("picked_up_at")
  deliveredAt       DateTime? @map("delivered_at")

  // Payment
  paymentMethod PaymentMethod @map("payment_method")
  paymentStatus PaymentStatus @default(PENDING) @map("payment_status")

  // Tracking
  trackingNumber  String  @unique @map("tracking_number")
  proofOfDelivery String? @map("proof_of_delivery") // URL to photo
  signature       String? // URL to signature image

  notes     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  sender   Rider     @relation("DeliverySender", fields: [senderId], references: [id])
  merchant Merchant? @relation(fields: [merchantId], references: [id])
  payment  Payment?

  @@index([senderId, status])
  @@index([trackingNumber])
  @@map("deliveries")
}

// ===========================================
// CEERION (EV FINANCING) MODELS
// ===========================================

model CeerionVehicle {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  vehicleId       String   @unique @map("vehicle_id") @db.Uuid
  financingStatus String   @default("active") @map("financing_status") // active, paid_off, defaulted
  totalAmount     Decimal  @map("total_amount") @db.Decimal(12, 2)
  amountPaid      Decimal  @default(0) @map("amount_paid") @db.Decimal(12, 2)
  amountRemaining Decimal  @map("amount_remaining") @db.Decimal(12, 2)
  currency        Currency
  weeklyPayment   Decimal  @map("weekly_payment") @db.Decimal(12, 2)
  paymentDay      Int      @map("payment_day") // day of week
  startDate       DateTime @map("start_date")
  endDate         DateTime @map("end_date")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  vehicle  Vehicle          @relation(fields: [vehicleId], references: [id])
  payments CeerionPayment[]

  @@map("ceerion_vehicles")
}

model CeerionPayment {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ceerionVehicleId String    @map("ceerion_vehicle_id") @db.Uuid
  amount           Decimal   @db.Decimal(12, 2)
  dueDate          DateTime  @map("due_date")
  paidAt           DateTime? @map("paid_at")
  status           String    @default("pending") // pending, paid, overdue
  source           String? // manual, auto_deduction
  createdAt        DateTime  @default(now()) @map("created_at")

  ceerionVehicle CeerionVehicle @relation(fields: [ceerionVehicleId], references: [id])

  @@index([ceerionVehicleId, status])
  @@map("ceerion_payments")
}

// ===========================================
// NOTIFICATION MODELS
// ===========================================

model Notification {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  type      String // ride_update, payment, promo, system
  title     String
  body      String
  data      Json?
  read      Boolean   @default(false)
  readAt    DateTime? @map("read_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read, createdAt])
  @@map("notifications")
}
